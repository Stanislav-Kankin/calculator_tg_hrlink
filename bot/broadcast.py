from aiogram import Bot
from aiogram.types import InputMediaPhoto, FSInputFile
from sqlalchemy.orm import sessionmaker
from sqlalchemy import create_engine
from models import UserData
import os


async def send_broadcast(bot: Bot):
    # –ü–æ–ª—É—á–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
    base_dir = os.path.dirname(os.path.abspath(__file__))
    images_dir = os.path.join(base_dir, 'images')

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
    # image_paths = [
    #     os.path.join(images_dir, '1.jpg'),
    #     os.path.join(images_dir, '2.jpg'),
    #     os.path.join(images_dir, '3.jpg'),
    #     os.path.join(images_dir, '4.jpg')
    # ]

    image_paths = [
        os.path.join(images_dir, 'march12.jpg')
    ]

    # –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
    engine = create_engine('sqlite:///user_data.db')
    Session = sessionmaker(bind=engine)
    session = Session()

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    users = session.query(UserData).all()

    # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å HTML-—Ä–∞–∑–º–µ—Ç–∫–æ–π –¥–ª—è —Å—Å—ã–ª–∫–∏
    message_text = (
        "üë• –í–æ –≤—Ä–µ–º—è –∫—Ä–∏–∑–∏—Å–∞ –Ω–∞ —Ä—ã–Ω–∫–µ —Ç—Ä—É–¥–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É "
        "–∫–∞–∫ –∫ –∫–ª–∏–µ–Ω—Ç—É, —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö –µ–≥–æ "
        "–ø—É—Ç–∏ –≤ –∫–æ–º–ø–∞–Ω–∏–∏. –ö–∞–∫ –∏ –∫–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ "
        "–ø—Ä–∏–º–µ–Ω—è—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ –≤ 2025 –≥–æ–¥—É?\n\n" 

"–†–∞—Å—Å–∫–∞–∂–µ–º <b>12 –º–∞—Ä—Ç–∞ –≤ 11:00 –ú–°–ö –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏ ¬´–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç—ã –≤ 2025 –≥–æ–¥—É¬ª</b>"
" —Å –≤–µ–¥—É—â–∏–º–∏ —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏ —Ä—ã–Ω–∫–∞.\n\n"

"‚Äî –ö–∞–∫ —Ä–µ—à–µ–Ω–∏—è –æ—Ç HRlink, Skillaz –∏ Trivio —É–ø—Ä–æ—â–∞—é—Ç –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø Employee Journey Map.\n"
"‚Äî –ö–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ò–ò –º–æ–≥—É—Ç –ø–æ–º–æ—á—å –≤ HR –≤ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö –∏ –∫–∞–∫ –ø—Ä–∏–º–µ–Ω—è—Ç—å –∏—Ö –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.\n"
"‚Äî –ö–∞–∫ –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ –∏ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.\n\n"

"3 –¥–æ–∫–ª–∞–¥–∞, 2 –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞, –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –∏ –±–æ–ª–µ–µ 700 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∞.\n\n"

"<b>–ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–ª—É—á–∏—Ç –¥–∏–ø–ª–æ–º –æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –æ–±—É—á–µ–Ω–∏—è ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ —Ä–µ–∑—é–º–µ –Ω–∞ hh.ru –∏ —Å—Ç–∞–Ω—å—Ç–µ –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–º –¥–ª—è —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–π.</b>\n\n"

"–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∏ –ø–æ–ª—É—á–∏—Ç–µ –≥–∞–π–¥ ¬´–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ò–ò –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞—á HR –∏ —Ä–µ–∫—Ä—É—Ç–µ—Ä–æ–≤¬ª, –∞ —Ç–∞–∫–∂–µ –ø–æ–¥–∞—Ä–∫–∏ –æ—Ç ¬´–Ø–Ω–¥–µ–∫—Å –ü—Ä–∞–∫—Ç–∏–∫—É–º¬ª, ¬´–õ–∏—Ç—Ä–µ—Å¬ª –∏ ¬´–Ø—Å–Ω–æ¬ª\n\n"
        '‚û°Ô∏è<a href="https://hr-link.ru/employees_2025?utm_source=telegram&utm_medium=bot&utm_term=calculator&utm_content=free%7C&utm_campaign=employees_2025"><b>–£—á–∞–≤—Å—Ç–≤–æ–≤–∞—Ç—å</b></a>üëà'
    )

    # –§–æ—Ä–º–∏—Ä—É–µ–º –º–µ–¥–∏–∞–≥—Ä—É–ø–ø—É
    media = [InputMediaPhoto(
        media=FSInputFile(image_path)) for image_path in image_paths]
    media[0].caption = message_text
    media[0].parse_mode = 'HTML'

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    for user in users:
        try:
            await bot.send_media_group(chat_id=user.user_id, media=media)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.user_id}: {e}")

    session.close()
